/**
 * An angular library for xbmc
 *
 * @version v0.1.0
 * @date 2014-03-29 15:59:13 GMT+0100
 * @link https://github.com/instabledesign/angular-xbmc
 * @license GNU GPL v2
 */
"use strict";angular.module("xbmc",["websocket"]).service("xbmc",["$rootScope","xbmcIntrospection","xbmcRequest",function(a,b){var c=this;c.isReady=!1,c.onReady=function(b){c.isReady?b.call():a.$on("xbmc.introspected",function(a,d){c.isReady=!0,angular.extend(c,d),b.call()})},c.getTypeFields=b.getTypeFields}]),angular.module("xbmc").service("xbmcCache",[function(){var a=this;a.cache={},a.get=function(b){return a.cache[b]||{}}}]),angular.module("xbmc").service("xbmcIntrospection",["$rootScope",function(a){var b=this;b.schema={},b.introspection={},b.introspect=function(c,d){b.schema=c,angular.forEach(c.methods,function(a,c){var e=c.split(".");b.introspection[e[0]]=b.introspection[e[0]]||{},b.introspection[e[0]][e[1]]=b.introspection[e[0]][e[1]]||function(a){return function(b,c){return d(a,b,c)}}(c)},b),angular.forEach(c.notifications,function(b,c){var d=this,e=c.split(".");d.introspection[e[0]]=d.introspection[e[0]]||{},d.introspection[e[0]][e[1]]=d.introspection[e[0]][e[1]]||function(b){return function(c){a.$on("websocket."+b,function(a,b){c(b.params)})}}(c)},b),a.$emit("xbmc.introspected",b.introspection)},b.getTypeFields=function(a){var c=b.schema.types;if(c[a].items&&c[a].items.enums)return c[a].items.enums;if(c[a].enums)return c[a].enums;throw"The type "+a+" has no fields."}}]),angular.module("xbmc").service("xbmcORM",["xbmcORMCollection","xbmcMovieRepository","xbmcAlbumRepository","xbmcSongRepository","xbmcGenreRepository","xbmcArtistRepository","xbmcTvshowRepository","xbmcSeasonRepository","xbmcEpisodeRepository","xbmcPlayerRepository",function(a,b,c,d,e,f,g,h,i,j){function k(a){if(a.result.movies||a.result.moviedetails)return b;if(a.result.albums||a.result.albumdetails)return c;if(a.result.songs||a.result.songdetails)return d;if(a.result.artists||a.result.artistdetails)return f;if(a.result.tvshows||a.result.tvshowdetails)return g;if(a.result.seasons)return h;if(a.result.episodes||a.result.episodedetails)return i;if(a.result.genres)return e;if(angular.isArray(a.result))for(var k in a.result)if(void 0!=a.result[k].playerid)return j;return!1}return this.processData=function(b){var c=k(b);return!1!==c?c.hydrate(b):new a},this}]).factory("xbmcORMCollection",[function(){function a(){return this}return a.prototype.addItem=function(a){this[a._id]=a},a.prototype.removeItem=function(a){this[a._id]&&delete this[a._id]},a.prototype.getByLabelKey=function(){var a={};return angular.forEach(this,function(b){a[b.label]=b}),a},a.prototype.filter=function(a){var b=[];return angular.forEach(this,function(c){var d=new RegExp(a);d.test(c.label)&&b.push(c)}),b},a}]),angular.module("xbmc").service("xbmcRequest",["$rootScope","$websocket","$q","xbmcORM","xbmcIntrospection","$log",function(a,b,c,d,e,f){function g(a,b){n.push({requestKey:l(a),datetimeToProcess:(new Date).getTime(),request:a,defer:b})}function h(a){var b=l(a.request);a.datetimeInProcess=(new Date).getTime(),o[b]=a}function i(a,b,c){var d=l(a.request);a.datetimeProcessed=(new Date).getTime(),a.response=b||null,a.result=c||null,p[d]=a}function j(a,b){var c=l(a.request);a.datetimeFailed=(new Date).getTime(),a.error=b,q[c]=a}function k(){if(Object.keys(o).length<m.requestParallel){var a=n[0];if(a){var c=l(a.request);n.splice(0,1),h(a),b.request(a.request).then(function(b){var e=d.processData(b);i(a,b,e),delete o[c],k(),a.defer.resolve(e)}).catch(function(b){j(a,b),delete o[c],k(),a.defer.reject(a)})}}}function l(a){return JSON.stringify([a.method,a.params])}var m=this;m.requestParallel=2,m.requestInProcessLifeTime=30,m.requestProcessedLifeTime=300;var n=[],o={},p={},q={};m.getRequestsToProcess=function(){return n},m.getRequestToProcess=function(a){for(var b in n)if(a==n[b].requestKey)return n;return!1},m.getRequestsInProcess=function(){return o},m.getRequestInProcess=function(a){return o[a]||!1},m.getRequestsProcessed=function(){return p},m.getRequestProcessed=function(a){return p[a]||!1},m.getRequestsFailed=function(){return q},m.getRequestFailed=function(a){return q[a]},m.validate=function(a){return!0},m.request=function(a,b,d){0!=d&&(d=!0);var e=c.defer(),f={method:a,params:b||{}};try{m.validate(f);var h=m.getStatus(f);if(h&&d){var d=m.getCache(f);"ToProcess"==h?e=d.defer:"InProcess"==h?e=d.defer:"Processed"==h&&d.result&&e.resolve(d.result)}else g(f,e),k()}catch(i){e.reject(i)}return e.promise},m.getStatus=function(a){var b=l(a);return p[b]?"Processed":o[b]?"InProcess":m.getRequestToProcess(b)?"ToProcess":!1},m.getCache=function(a){var b=l(a);return o[b]&&o[b].datetimeInProcess+1e3*m.requestInProcessLifeTime>(new Date).getTime()?o[b]:p[b]&&p[b].datetimeProcessed+1e3*m.requestProcessedLifeTime>(new Date).getTime()?p[b]:m.getRequestToProcess(b)},m.addRequestToProcess=function(a,b){m.requestToProcess.push({requestKey:l(a),datetimeToProcess:(new Date).getTime(),request:a,defer:b})},m.addRequestInProcess=function(a){var b=l(a.request);a.datetimeInProcess=(new Date).getTime(),m.requestInProcess[b]=a},m.addRequestProcessed=function(a,b,c){var d=l(a.request);a.datetimeProcessed=(new Date).getTime(),a.response=b||null,a.result=c||null,m.requestProcessed[d]=a},m.addRequestFailed=function(a,b){var c=l(a.request);a.datetimeFailed=(new Date).getTime(),a.error=b,m.requestFailed[c]=a},a.$on("websocket.connected",function(){b.request({method:"JSONRPC.Introspect"}).then(function(a){e.introspect(a.result,m.request)})})}]),angular.module("xbmc").factory("xbmcAlbumEntity",["$q","xbmcIntrospection","xbmcORMCollection",function(a,b,c){function d(){var a=this;return a._id,a._songs={},a._genres={},a._artists={},a}return d.prototype={getDetails:function(){var a={albumid:this._id,properties:b.getTypeFields("Audio.Fields.Album")};return b.introspection.AudioLibrary.GetAlbumDetails(a)},getGenres:function(){var d=this,e=a.defer(),f={properties:b.getTypeFields("Library.Fields.Genre")};return b.introspection.AudioLibrary.GetGenres(f).then(function(a){var b=new c;angular.forEach(d.genreid,function(c){if(a[c]){var e=a[c];d._genres[e._id]=e,b.addItem(e),e._albums[d._id]=d}}),e.resolve(b)}).catch(function(a){e.reject(a)}),e.promise},getArtists:function(){var d=this,e=a.defer(),f={filter:{albumid:this._id},properties:b.getTypeFields("Audio.Fields.Artist")};return b.introspection.AudioLibrary.GetArtists(f).then(function(a){var b=new c;angular.forEach(a,function(a){d._artists[a._id]=a,b.addItem(a),a._albums[d._id]=d}),e.resolve(b)}).catch(function(a){e.reject(a)}),e.promise},getSongs:function(){var c=this,d=a.defer(),e={filter:{albumid:this._id},properties:b.getTypeFields("Audio.Fields.Song")};return b.introspection.AudioLibrary.GetSongs(e).then(function(a){angular.forEach(a,function(a){c._songs[a._id]=a,a._album[c._id]=c}),d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise}},d}]),angular.module("xbmc").factory("xbmcArtistEntity",["$q","xbmcIntrospection",function(a,b){function c(){var a=this;return a._id,a._songs={},a._albums={},a}return c.prototype={getDetails:function(){var a={artistid:this._id,properties:b.getTypeFields("Audio.Fields.Artist")};return b.introspection.AudioLibrary.GetArtistDetails(a)},getSongs:function(){var a=this,c={filter:{artistid:this._id},properties:b.getTypeFields("Audio.Fields.Song")},d=b.introspection.AudioLibrary.GetSongs(c);return d.then(function(b){a._songs=b}),d}},c}]),angular.module("xbmc").factory("xbmcEpisodeEntity",["$q","xbmcIntrospection",function(a,b){function c(){var a=this;return a._id,a._tvshow={},a._season={},a}return c.prototype={getDetails:function(){var a={episodeid:this._id,properties:b.getTypeFields("Video.Fields.Episode")};return b.introspection.VideoLibrary.GetTVShowDetails(a)},getTVShow:function(){var c=this,d=a.defer(),e={tvshowid:c._id,properties:b.getTypeFields("Video.Fields.TVShow")};return b.introspection.VideoLibrary.GetTVShowDetails(e).then(function(a){c._tvshow=a,a._seasons[c._id]=c,d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise},getSeason:function(){var c=this,d=a.defer(),e={tvshowid:c.tvshowid,properties:b.getTypeFields("Video.Fields.Season")};return b.introspection.VideoLibrary.GetSeasons(e).then(function(a){if(a[c.season]){var b=a[c.season];c._season=b,b._episodes[c._id]=c}d.resolve(c._season)}).catch(function(a){d.reject(a)}),d.promise}},c}]),angular.module("xbmc").factory("xbmcGenreEntity",[function(){function a(){var a=this;return a._id,a._songs={},a._albums={},a._movies={},a._artists={},a._tvshows={},a}return a}]),angular.module("xbmc").factory("xbmcMovieEntity",["$q","xbmcIntrospection","xbmcORMCollection",function(a,b,c){function d(){var a=this;return a._id,a._genres={},a}return d.prototype={getDetails:function(){var a={movieid:this._id,properties:b.getTypeFields("Video.Fields.Movie")};return b.introspection.VideoLibrary.GetMovieDetails(a)},getGenres:function(){var d=this,e=a.defer(),f={type:"movie",properties:b.getTypeFields("Library.Fields.Genre")};return b.introspection.VideoLibrary.GetGenres(f).then(function(a){var b=a.getByLabelKey(),f=new c;angular.forEach(d.genre,function(a){if(b[a]){var c=b[a];d._genres[c._id]=c,f.addItem(c),c._movies[d._id]=d}}),e.resolve(f)}).catch(function(a){e.reject(a)}),e.promise},play:function(){var a={playlistid:1,position:0,item:{movieid:this._id}};return b.introspection.Playlist.Insert(a).then(function(a){"OK"==a.status&&b.introspection.Player.Open({item:{playlistid:1}},!1)}),!0}},d}]),angular.module("xbmc").factory("xbmcPlayerEntity",["$q","xbmcIntrospection","$interval",function(a,b,c){function d(){var a=this;return a._id,a._item={},a.interval,a}return d.prototype={getProperties:function(){var c=this,d=a.defer(),e={playerid:this._id,properties:b.getTypeFields("Player.Property.Name")};return b.introspection.Player.GetProperties(e).then(function(a){angular.extend(c,a.result),d.resolve(c)}).catch(function(a){d.reject(a)}),d.promise},getItem:function(){var c=this,d=a.defer(),e={playerid:c.playerid,properties:b.getTypeFields("List.Fields.All")};return b.introspection.Player.GetItem(e).then(function(a){c._item=a.result.item,d.resolve(c._item)}).catch(function(a){d.reject(a)}),d.promise},playPause:function(){var a=this,c={playerid:a.playerid};b.introspection.Player.PlayPause(c,!1)},onChangeSpeed:function(a){function b(){var a=(60*e.time.hours*60*1e3||0)+(60*e.time.minutes*1e3||0)+(1e3*e.time.seconds||0)+(e.time.milliseconds||0),b=(60*e.totaltime.hours*60*1e3||0)+(60*e.totaltime.minutes*1e3||0)+(1e3*e.totaltime.seconds||0)+(e.totaltime.milliseconds||0);e.percentage=a/b*100}function d(){e.time.seconds++,e.time.seconds>59&&(e.time.seconds=0,e.time.minutes++,e.time.minutes>59&&(e.time.minutes=0,e.time.hours++))}var e=this;e.speed=a,e.interval?0==e.speed&&(c.cancel(e.interval),e.interval=void 0):e.interval=c(function(){d(),b()},1e3)}},d}]),angular.module("xbmc").factory("xbmcSeasonEntity",["$q","xbmcIntrospection","xbmcORMCollection",function(a,b,c){function d(){var a=this;return a._id,a._tvshow,a._episodes={},a}return d.prototype={getTVShow:function(){var c=this,d=a.defer(),e={tvshowid:c._id,properties:b.getTypeFields("Video.Fields.TVShow")};return b.introspection.VideoLibrary.GetTVShowDetails(e).then(function(a){c._tvshow=a,a._seasons[c._id]=c,d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise},getEpisodes:function(d){var e=this,f=a.defer(),d={tvshowid:this._id,properties:b.getTypeFields("Video.Fields.Episode")};return b.introspection.VideoLibrary.GetEpisodes(d).then(function(a){var b=new c;angular.forEach(a,function(a){e._episodes[a._id]=a,b.addItem(a),a._tvshow=e}),f.resolve(b)}).catch(function(a){f.reject(a)}),f.promise}},d}]),angular.module("xbmc").factory("xbmcSongEntity",["$q","xbmcIntrospection","xbmcORMCollection",function(a,b,c){function d(){var a=this;return a._id,a._artist,a._album={},a._genres={},a}return d.prototype={getDetails:function(){var a={songid:this._id,properties:b.getTypeFields("Audio.Fields.Song")};return b.introspection.AudioLibrary.GetSongDetails(a)},getGenres:function(){var d=this,e=a.defer(),f={properties:b.getTypeFields("Library.Fields.Genre")};return b.introspection.AudioLibrary.GetGenres(f).then(function(a){var b=new c;angular.forEach(d.genreid,function(c){if(a[c]){var e=a[c];d._genres[e._id]=e,b.addItem(e),e._songs[d._id]=d}}),e.resolve(b)}).catch(function(a){e.reject(a)}),e.promise},getAlbum:function(){var c=this,d=a.defer(),e={albumid:c.albumid,properties:b.getTypeFields("Audio.Fields.Album")};return b.introspection.AudioLibrary.GetAlbumDetails(e).then(function(a){c._album=a,a._songs[c._id]=c,d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise},getArtist:function(){var c=this,d=a.defer(),e={filter:{songid:c._id},properties:b.getTypeFields("Audio.Fields.Artist")};return b.introspection.AudioLibrary.GetArtists(e).then(function(a){c._artist=a[c.artistid],a[c.artistid]._songs[c._id]=c,d.resolve(c._artist)}).catch(function(a){d.reject(a)}),d.promise},play:function(){var a={playlistid:0,position:0,item:{songid:this._id}};return b.introspection.Playlist.Insert(a).then(function(a){"OK"==a&&b.introspection.Player.Open({item:{playlistid:0}},!1)}),!0}},d}]),angular.module("xbmc").factory("xbmcTvshowEntity",["$q","xbmcIntrospection","xbmcORMCollection",function(a,b,c){function d(){var a=this;return a._id,a._genres={},a._seasons={},a._episodes={},a}return d.prototype={getDetails:function(){var a={tvshowid:this._id,properties:b.getTypeFields("Video.Fields.TVShow")};return b.introspection.VideoLibrary.GetTVShowDetails(a)},getGenres:function(){var d=this,e=a.defer(),f={type:"tvshow",properties:b.getTypeFields("Library.Fields.Genre")};return b.introspection.VideoLibrary.GetGenres(f).then(function(a){var b=a.getByLabelKey(),f=new c;angular.forEach(d.genre,function(a){if(b[a]){var c=b[a];d._genres[c._id]=c,f.addItem(c),c._movies[d._id]=d}}),e.resolve(f)}).catch(function(a){e.reject(a)}),e.promise},getSeasons:function(){var d=this,e=a.defer(),f={tvshowid:d._id,properties:b.getTypeFields("Video.Fields.Season")};return b.introspection.VideoLibrary.GetSeasons(f).then(function(a){var b=new c;angular.forEach(a,function(a){d._seasons[a._id]=a,b.addItem(a),a._tvshow=d}),e.resolve(b)}).catch(function(a){e.reject(a)}),e.promise},getEpisodes:function(){var d=this,e=a.defer(),f={tvshowid:this._id,properties:b.getTypeFields("Video.Fields.Episode")};return b.introspection.VideoLibrary.GetEpisodes(f).then(function(a){var b=new c;angular.forEach(a,function(a){d._episodes[a._id]=a,b.addItem(a),a._tvshow=d}),e.resolve(b)}).catch(function(a){e.reject(a)}),e.promise}},d}]),angular.module("xbmc").service("xbmcAlbumRepository",["xbmcAlbumEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.albums=new c;d.hydrate=function(a){return a.result.albums?d.createOrUpdateAlbums(a.result.albums):a.result.albumdetails?d.createOrUpdateAlbum(a.result.albumdetails):void 0},d.createOrUpdateAlbum=function(b){var c=e[b.albumid]||new a;return angular.extend(c,b),c._id=b.albumid,e.addItem(c),c},d.createOrUpdateAlbums=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateAlbum(a))}),b}}}]),angular.module("xbmc").service("xbmcArtistRepository",["xbmcArtistEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.artists=new c;d.hydrate=function(a){return a.result.artists?d.createOrUpdateArtists(a.result.artists):a.result.artistdetails?d.createOrUpdateArtist(a.result.artistdetails):void 0},d.createOrUpdateArtist=function(b){var c=e[b.artistid]||new a;return angular.extend(c,b),c._id=b.artistid,e.addItem(c),c},d.createOrUpdateArtists=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateArtist(a))}),b}}}]),angular.module("xbmc").service("xbmcEpisodeRepository",["xbmcEpisodeEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.episodes=new c;d.hydrate=function(a){return a.result.episodes?d.createOrUpdateEpisodes(a.result.episodes):a.result.episodedetails?d.createOrUpdateEpisode(a.result.episodedetails):void 0},d.createOrUpdateEpisode=function(b){var c=e[b.episodeid]||new a;return angular.extend(c,b),c._id=b.episodeid,e.addItem(c),c},d.createOrUpdateEpisodes=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateEpisode(a))}),b}}}]),angular.module("xbmc").service("xbmcGenreRepository",["xbmcGenreEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.genres=new c;d.hydrate=function(a){return a.result.genres?d.createOrUpdateGenres(a.result.genres):void 0},d.createOrUpdateGenre=function(b){var c=e[b.genreid]||new a;return angular.extend(c,b),c._id=b.genreid,e.addItem(c),c},d.createOrUpdateGenres=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateGenre(a))}),b}}}]),angular.module("xbmc").service("xbmcMovieRepository",["xbmcMovieEntity","xbmcCache","xbmcORMCollection",function(a,b,c){function d(b){var c=g[b.movieid]||new a;return angular.extend(c,b),c._id=b.movieid,g.addItem(c),c}function e(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d(a))}),b}}var f=this,g=b.cache.movies=new c;f.hydrate=function(a){return a.result.movies?e(a.result.movies):a.result.moviedetails?d(a.result.moviedetails):void 0}}]),angular.module("xbmc").service("xbmcPlayerRepository",["$rootScope","xbmcPlayerEntity","xbmcCache","xbmcORMCollection",function(a,b,c,d){var e=this,f=c.cache.players=new d;e.hydrate=function(a){return e.createOrUpdatePlayers(a.result)},e.createOrUpdatePlayer=function(a){var c=f[a.playerid]||new b;return angular.extend(c,a),c._id=a.playerid,f.addItem(c),c},e.createOrUpdatePlayers=function(a){if(angular.isArray(a)){var b=new d;return angular.forEach(a,function(a){b.addItem(e.createOrUpdatePlayer(a))}),b}},a.$on("websocket.Player.OnPlay",function(a,b){if(b.params.data.player){var c=b.params.data.player;f[c.playerid]&&f[c.playerid].onChangeSpeed(c.speed)}}),a.$on("websocket.Player.OnPause",function(a,b){if(b.params.data.player){var c=b.params.data.player;f[c.playerid]&&f[c.playerid].onChangeSpeed(c.speed)}})}]),angular.module("xbmc").service("xbmcSeasonRepository",["xbmcSeasonEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.seasons=new c;d.hydrate=function(a){return a.result.seasons?d.createOrUpdateSeasons(a.result.seasons):a.result.seasondetails?d.createOrUpdateSeason(a.result.seasondetails):void 0},d.createOrUpdateSeason=function(b){var c=e[b.season]||new a;return angular.extend(c,b),c._id=b.season,e.addItem(c),c},d.createOrUpdateSeasons=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateSeason(a))}),b}}}]),angular.module("xbmc").service("xbmcSongRepository",["xbmcSongEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.songs=new c;d.hydrate=function(a){return a.result.songs?d.createOrUpdateSongs(a.result.songs):a.result.songdetails?d.createOrUpdateSong(a.result.songdetails):void 0},d.createOrUpdateSong=function(b){var c=e[b.songid]||new a;return angular.extend(c,b),c._id=b.songid,e.addItem(c),c},d.createOrUpdateSongs=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateSong(a))}),b}}}]),angular.module("xbmc").service("xbmcTvshowRepository",["xbmcTvshowEntity","xbmcCache","xbmcORMCollection",function(a,b,c){var d=this,e=b.cache.tvshows=new c;d.hydrate=function(a){return a.result.tvshows?d.createOrUpdateTvshows(a.result.tvshows):a.result.tvshowdetails?d.createOrUpdateTvshow(a.result.tvshowdetails):void 0},d.createOrUpdateTvshow=function(b){var c=e[b.tvshowid]||new a;return angular.extend(c,b),c._id=b.tvshowid,e.addItem(c),c},d.createOrUpdateTvshows=function(a){if(angular.isArray(a)){var b=new c;return angular.forEach(a,function(a){b.addItem(d.createOrUpdateTvshow(a))}),b}}}]);